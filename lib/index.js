"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.punycode = exports.whois = exports.reverse = exports.groper = void 0;

var dns = _interopRequireWildcard(require("native-dns"));

var _net = _interopRequireDefault(require("net"));

var _punycode = _interopRequireDefault(require("punycode"));

var _tldjs = _interopRequireDefault(require("tldjs"));

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

function _interopRequireWildcard(obj) { if (obj && obj.__esModule) { return obj; } else { var newObj = {}; if (obj != null) { for (var key in obj) { if (Object.prototype.hasOwnProperty.call(obj, key)) { var desc = Object.defineProperty && Object.getOwnPropertyDescriptor ? Object.getOwnPropertyDescriptor(obj, key) : {}; if (desc.get || desc.set) { Object.defineProperty(newObj, key, desc); } else { newObj[key] = obj[key]; } } } } newObj.default = obj; return newObj; } }

function _defineProperty(obj, key, value) { if (key in obj) { Object.defineProperty(obj, key, { value: value, enumerable: true, configurable: true, writable: true }); } else { obj[key] = value; } return obj; }

var topLevelWhoisServerDomai = 'whois-servers.net';
var dnsTypes = ['A', 'AAAA', 'NS', 'CNAME', 'PTR', 'NAPTR', 'TXT', 'MX', 'SRV', 'SOA', 'TLSA'];
var ipMatcher = /^(?:(?:2[0-4]\d|25[0-5]|1\d{2}|[1-9]?\d)\.){3}(?:2[0-4]\d|25[0-5]|1\d{2}|[1-9]?\d)$/;
var defaultDnsServer = {
  address: '1.1.1.1',
  port: 53,
  type: 'tcp'
};
var defaultTimeout = 3000;
/**
 * node-dns wrapper method.
 * type is resource record type. example "A", "MX" etc.
 * option is node-dns remote end point option.
 * { address: "ip address", port: "remote port number", type: "udp or tcp"}
 * timeout is a number in milliseconds that is wait for the request to finish.
 *
 * @param {String} domain
 * @param {Array} types
 * @param {IdnsServer} option
 * @param {Number} timeout
 * @returns {Promise}
 */

function requestDns(domain, types, option, timeout) {
  var promises = [];
  var recordTypes = [];

  if (!types || types.length === 0) {
    recordTypes = ['A'];
  } else {
    recordTypes = types;
  }

  recordTypes.map(function (type) {
    promises.push(ajaxRequest(domain, type, option, timeout));
  });
  return new Promise(function (resolve, reject) {
    Promise.all(promises).then(function (values) {
      var response = {};
      values.map(function (obj) {
        Object.keys(obj).map(function (k) {
          response[k] = obj[k];
        });
      });
      resolve(response);
    }).catch(function (err) {
      reject(err);
    });
  });
}
/**
 * This method asynchronously requests the dns server.
 * This method return promise object as execution result.
 *
 * @param {String} domain
 * @param {Array} type
 * @param {IdnsServer} dnsServer
 * @param {Number} timeout
 * @returns {Promise}
 */


function ajaxRequest(domain, type, dnsServer) {
  var timeout = arguments.length > 3 && arguments[3] !== undefined ? arguments[3] : defaultTimeout;
  var server = defaultDnsServer;
  return new Promise(function (resolve, reject) {
    var questionOpts = {
      name: domain,
      type: type
    };
    var requestOption = {
      cache: false,
      question: dns.Question(questionOpts),
      server: Object.assign(server, dnsServer),
      timeout: timeout
    };

    if (timeout) {
      requestOption.timeout = timeout;
    }

    var request = dns.Request(requestOption);
    request.on('timeout', function () {
      reject(new Error('DNS request timed out'));
    });
    request.on('cancelled', function () {
      reject(new Error('DNS request cancelled'));
    });
    request.on('error', function (error) {
      reject(error);
    });
    request.on('message', function (_, response) {
      resolve(_defineProperty({}, type, response.answer));
    });
    request.send();
  });
}
/**
 * Validate resource record type.
 *
 * @param {Array|String} types
 * @return {Array}
 */


function validateDnsType(types) {
  if (!types || types !== 'ANY' && typeof types.length !== 'number') {
    throw new Error('Expected a `types is Array`');
  }

  var recordTypes;
  var validTypes = [];

  if (types === 'ANY' || types.includes('ANY')) {
    recordTypes = dnsTypes;
  } else {
    if (typeof types === 'string') {
      recordTypes = [types];
    } else {
      recordTypes = types;
    }
  }

  recordTypes.forEach(function (type) {
    var matched = dnsTypes.find(function (elem) {
      return type.toUpperCase() === elem;
    });

    if (typeof matched === 'string') {
      validTypes.push(matched);
    }
  });
  return validTypes;
}
/**
 * Get Whois server and Whois domain.
 * First, Make the FQDN that was the TLD + whois-servers.net.
 *
 * @param {String} domain
 * @param {Object} options
 * @return {Promise}
 */


function requestWhois(domain, options) {
  var whoisServer, port;
  return new Promise(function (resolve, reject) {
    var func = function func(domain, whoisServer, port) {
      getWhoisDomain(domain, whoisServer, port).then(function (data) {
        resolve(data);
      }).catch(function (error) {
        reject(error);
      });
    };

    if (options && options.server) {
      whoisServer = options.server;

      if (options.port) {
        port = options.port;
      }

      func.call(null, domain, whoisServer, port);
    } else {
      getTopLevelWhoisServer(domain).then(function (whoisServers) {
        whoisServer = whoisServers[0];
        func.call(null, domain, whoisServer, port);
      }).catch(function (error) {
        reject(error);
      });
    }
  });
}
/**
 * Get the whois server of the top level domain
 *
 * @param {String} domain
 * @return {Promise}
 */


function getTopLevelWhoisServer(domain) {
  var tmp = domain.split('.'),
      tld = tmp[tmp.length - 1],
      cname = "".concat(tld, ".").concat(topLevelWhoisServerDomai),
      messege = {
    not_found: 'Whois Server `NOT FOUND`'
  };
  return new Promise(function (resolve, reject) {
    dns.resolveCname(cname, function (error, servers) {
      if (servers && servers.length > 0) {
        resolve(servers);
      } else {
        !error ? reject(messege.not_found) : reject(error);
      }
    });
  });
}
/**
 * Get whois information of the domain
 *
 * @param {String} domain
 * @param {String} server
 * @return {Promise}
 */


function getWhoisDomain(domain, server) {
  var port = arguments.length > 2 && arguments[2] !== undefined ? arguments[2] : 43;

  if (!domain) {
    throw new Error('`domain` is required');
  }

  if (!server) {
    throw new Error('`server` is required');
  }

  var socket = new _net.default.Socket();
  var encoding = 'utf8';
  return new Promise(function (resolve, reject) {
    socket.setEncoding(encoding);
    socket.connect(port, server, function () {
      socket.end(domain + '\r\n', encoding);
    });
    socket.on('data', function (data) {
      resolve(data);
    });
    socket.on('error', function (error) {
      reject(error);
    });
  });
}
/**
 * IP address reverse.
 * support ipv4 only.
 *
 * @param {String} ip
 * @return {Promise}
 */


function reverseDomain(ip) {
  if (!ipMatcher.test(ip)) {
    throw new Error('IP is not valid');
  }

  return new Promise(function (resolve, reject) {
    dns.reverse(ip, function (error, hostname) {
      if (reverse) {
        resolve(hostname);
      } else {
        reject(error);
      }
    });
  });
}
/**
 * Decode Punycode.
 *
 * @param {String} ascii
 * @return {String}
 */


function decodePuny(ascii) {
  return _punycode.default.toUnicode(ascii);
}
/**
 * Encode Punycode.
 *
 * @param {String} unicode
 * @return {String}
 */


function encodePuny(unicode) {
  return _punycode.default.toASCII(unicode);
}

var groper = function groper(domain, types, options, cb) {
  if (typeof domain !== 'string') {
    throw new Error('Expected a `domain`');
  }

  var defaultOptions = {
    server: defaultDnsServer,
    timeout: defaultTimeout
  };
  var callback;
  var requestOptions = defaultOptions;

  if (typeof types === 'function') {
    callback = types;
  } else if (typeof options === 'function') {
    callback = options;
    requestOptions = Object.assign(defaultOptions, cb);
  } else if (cb) {
    requestOptions = Object.assign(defaultOptions, options);
    callback = cb;
  }

  var domainName = encodePuny(domain);
  var type,
      server,
      timeout,
      resourceTypes = ['ANY'];

  if (typeof types === 'string') {
    resourceTypes = new Array(types);
  }

  if (Array.isArray(types)) {
    resourceTypes = types;
  }

  if (resourceTypes.includes('ANY')) {
    resourceTypes = ['ANY'];
  }

  type = validateDnsType(resourceTypes);

  if (type.length === 0) {
    throw new Error('Valid No `DNS TYPE` exitst');
  }

  if (requestOptions.server) {
    server = requestOptions.server;
  }

  if (requestOptions.timeout) {
    timeout = requestOptions.timeout;
  }

  var promise = requestDns(domainName, type, server, timeout);

  if (callback && typeof callback === 'function') {
    promise.then(function (data) {
      return callback(null, data);
    }).catch(function (error) {
      return callback(error, null);
    });
  } else {
    return promise;
  }
};

exports.groper = groper;

var reverse = function reverse(ip, cb) {
  if (typeof ip !== 'string') {
    throw new Error('Expected a `ip address`');
  }

  var promise = reverseDomain(ip);

  if (cb && typeof cb === 'function') {
    promise.then(function (data) {
      return cb(null, data);
    }).catch(function (error) {
      return cb(error, null);
    });
  } else {
    return promise;
  }
};

exports.reverse = reverse;

var whois = function whois(domain, opts, cb) {
  if (typeof domain !== 'string') {
    throw new Error('Expected a `domain name`');
  }

  var callback;

  if (typeof opts === 'function') {
    callback = opts;
  } else {
    callback = cb;
  }

  if (_tldjs.default.tldExists(domain) === false) {
    throw new Error('Invalid a `domain name`');
  }

  var encodedDomain = "".concat(encodePuny(domain)),
      promise = requestWhois(encodedDomain, opts);

  if (callback && typeof callback === 'function') {
    promise.then(function (data) {
      return callback(null, data);
    }).catch(function (error) {
      return callback(error, null);
    });
  } else {
    return promise;
  }
};

exports.whois = whois;

var punycode = function punycode(ascii_or_unicode) {
  var type = ascii_or_unicode.match(/^xn--/) ? 'decode' : 'encode';

  if (type === 'decode') {
    return decodePuny(ascii_or_unicode);
  } else {
    return encodePuny(ascii_or_unicode);
  }
};

exports.punycode = punycode;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL3NyYy9pbmRleC50cyJdLCJuYW1lcyI6WyJ0b3BMZXZlbFdob2lzU2VydmVyRG9tYWkiLCJkbnNUeXBlcyIsImlwTWF0Y2hlciIsImRlZmF1bHREbnNTZXJ2ZXIiLCJhZGRyZXNzIiwicG9ydCIsInR5cGUiLCJkZWZhdWx0VGltZW91dCIsInJlcXVlc3REbnMiLCJkb21haW4iLCJ0eXBlcyIsIm9wdGlvbiIsInRpbWVvdXQiLCJwcm9taXNlcyIsInJlY29yZFR5cGVzIiwibGVuZ3RoIiwibWFwIiwicHVzaCIsImFqYXhSZXF1ZXN0IiwiUHJvbWlzZSIsInJlc29sdmUiLCJyZWplY3QiLCJhbGwiLCJ0aGVuIiwidmFsdWVzIiwicmVzcG9uc2UiLCJvYmoiLCJPYmplY3QiLCJrZXlzIiwiayIsImNhdGNoIiwiZXJyIiwiZG5zU2VydmVyIiwic2VydmVyIiwicXVlc3Rpb25PcHRzIiwibmFtZSIsInJlcXVlc3RPcHRpb24iLCJjYWNoZSIsInF1ZXN0aW9uIiwiZG5zIiwiUXVlc3Rpb24iLCJhc3NpZ24iLCJyZXF1ZXN0IiwiUmVxdWVzdCIsIm9uIiwiRXJyb3IiLCJlcnJvciIsIl8iLCJhbnN3ZXIiLCJzZW5kIiwidmFsaWRhdGVEbnNUeXBlIiwidmFsaWRUeXBlcyIsImluY2x1ZGVzIiwiZm9yRWFjaCIsIm1hdGNoZWQiLCJmaW5kIiwiZWxlbSIsInRvVXBwZXJDYXNlIiwicmVxdWVzdFdob2lzIiwib3B0aW9ucyIsIndob2lzU2VydmVyIiwiZnVuYyIsImdldFdob2lzRG9tYWluIiwiZGF0YSIsImNhbGwiLCJnZXRUb3BMZXZlbFdob2lzU2VydmVyIiwid2hvaXNTZXJ2ZXJzIiwidG1wIiwic3BsaXQiLCJ0bGQiLCJjbmFtZSIsIm1lc3NlZ2UiLCJub3RfZm91bmQiLCJyZXNvbHZlQ25hbWUiLCJzZXJ2ZXJzIiwic29ja2V0IiwibmV0IiwiU29ja2V0IiwiZW5jb2RpbmciLCJzZXRFbmNvZGluZyIsImNvbm5lY3QiLCJlbmQiLCJyZXZlcnNlRG9tYWluIiwiaXAiLCJ0ZXN0IiwicmV2ZXJzZSIsImhvc3RuYW1lIiwiZGVjb2RlUHVueSIsImFzY2lpIiwicHVueSIsInRvVW5pY29kZSIsImVuY29kZVB1bnkiLCJ1bmljb2RlIiwidG9BU0NJSSIsImdyb3BlciIsImNiIiwiZGVmYXVsdE9wdGlvbnMiLCJjYWxsYmFjayIsInJlcXVlc3RPcHRpb25zIiwiZG9tYWluTmFtZSIsInJlc291cmNlVHlwZXMiLCJBcnJheSIsImlzQXJyYXkiLCJwcm9taXNlIiwid2hvaXMiLCJvcHRzIiwidGxkanMiLCJ0bGRFeGlzdHMiLCJlbmNvZGVkRG9tYWluIiwicHVueWNvZGUiLCJhc2NpaV9vcl91bmljb2RlIiwibWF0Y2giXSwibWFwcGluZ3MiOiI7Ozs7Ozs7QUFBQTs7QUFDQTs7QUFDQTs7QUFDQTs7Ozs7Ozs7QUFFQSxJQUFNQSx3QkFBd0IsR0FBRyxtQkFBakM7QUEwQ0EsSUFBTUMsUUFBa0IsR0FBRyxDQUN2QixHQUR1QixFQUV2QixNQUZ1QixFQUd2QixJQUh1QixFQUl2QixPQUp1QixFQUt2QixLQUx1QixFQU12QixPQU51QixFQU92QixLQVB1QixFQVF2QixJQVJ1QixFQVN2QixLQVR1QixFQVV2QixLQVZ1QixFQVd2QixNQVh1QixDQUEzQjtBQWNBLElBQU1DLFNBQWlCLEdBQUcscUZBQTFCO0FBQ0EsSUFBTUMsZ0JBQTRCLEdBQUc7QUFDakNDLEVBQUFBLE9BQU8sRUFBRSxTQUR3QjtBQUVqQ0MsRUFBQUEsSUFBSSxFQUFFLEVBRjJCO0FBR2pDQyxFQUFBQSxJQUFJLEVBQUU7QUFIMkIsQ0FBckM7QUFLQSxJQUFNQyxjQUFjLEdBQUcsSUFBdkI7QUFFQTs7Ozs7Ozs7Ozs7Ozs7QUFhQSxTQUFTQyxVQUFULENBQW9CQyxNQUFwQixFQUFvQ0MsS0FBcEMsRUFBc0RDLE1BQXRELEVBQTJFQyxPQUEzRSxFQUEyRztBQUN2RyxNQUFNQyxRQUE2QixHQUFHLEVBQXRDO0FBRUEsTUFBSUMsV0FBcUIsR0FBRyxFQUE1Qjs7QUFFQSxNQUFJLENBQUNKLEtBQUQsSUFB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QSxNQUFJekcsSUFBSSxLQUFLLFFBQWIsRUFBdUI7QUFDbkIsV0FBT2lGLFVBQVUsQ0FBQ3VCLGdCQUFELENBQWpCO0FBQ0gsR0FGRCxNQUVPO0FBQ0gsV0FBT25CLFVBQVUsQ0FBQ21CLGdCQUFELENBQWpCO0FBQ0g7QUFDSixDQVBNIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0ICogYXMgZG5zIGZyb20gJ25hdGl2ZS1kbnMnO1xuaW1wb3J0IG5ldCBmcm9tICduZXQnO1xuaW1wb3J0IHB1bnkgZnJvbSAncHVueWNvZGUnO1xuaW1wb3J0IHRsZGpzIGZyb20gJ3RsZGpzJztcblxuY29uc3QgdG9wTGV2ZWxXaG9pc1NlcnZlckRvbWFpID0gJ3dob2lzLXNlcnZlcnMubmV0JztcblxudHlwZSBjYWxsYmFja0Z1bmN0aW9uID0gKGVycjogRXJyb3IgfCBudWxsIHwgdW5kZWZpbmVkLCBkYXRhOiBhbnkpID0+IGFueTtcblxuaW50ZXJmYWNlIEl3aG9pc1NlcnZlciB7XG4gICAgcmVjb3JkVHlwZT86IHN0cmluZztcbiAgICBzZXJ2ZXI/OiBzdHJpbmc7XG4gICAgcG9ydD86IG51bWJlcjtcbn1cblxuaW50ZXJmYWNlIElkbnNTZXJ2ZXIge1xuICAgIGFkZHJlc3M6IHN0cmluZztcbiAgICBwb3J0OiBudW1iZXI7XG4gICAgdHlwZTogc3RyaW5nO1xufVxuXG5pbnRlcmZhY2UgSWRuc1Jlc3BvbnNlIHtcbiAgICBbdHlwZTogc3RyaW5nXTogSWRuc0Fuc3dlcjtcbn1cblxuaW50ZXJmYWNlIElkbnNSZXF1ZXN0UGFyYW1zIHtcbiAgICBxdWVzdGlvbj86IElkbnNRdWVzdGlvblJlc3BvbnNlO1xuICAgIHNlcnZlcj86IElkbnNTZXJ2ZXI7XG4gICAgdGltZW91dD86IG51bWJlcjtcbiAgICBjYWNoZT86IGJvb2xlYW47XG59XG5cbmludGVyZmFjZSBJZG5zUXVlc3Rpb25SZXNwb25zZSB7XG4gICAgbmFtZT86IHN0cmluZztcbiAgICB0eXBlOiBzdHJpbmc7XG4gICAgY2xhc3M6IHN0cmluZztcbn1cblxuaW50ZXJmYWNlIElkbnNBbnN3ZXIge1xuICAgIG5hbWU6IHN0cmluZztcbiAgICB0eXBlOiBudW1iZXI7XG4gICAgY2xhc3M6IG51bWJlcjtcbiAgICB0dGw6IG51bWJlcjtcbiAgICBhZGRyZXNzPzogc3RyaW5nO1xuICAgIGRhdGE/OiBzdHJpbmcgfCBzdHJpbmdbXTtcbn1cblxuY29uc3QgZG5zVHlwZXM6IHN0cmluZ1tdID0gW1xuICAgICdBJyxcbiAgICAnQUFBQScsXG4gICAgJ05TJyxcbiAgICAnQ05BTUUnLFxuICAgICdQVFInLFxuICAgICdOQVBUUicsXG4gICAgJ1RYVCcsXG4gICAgJ01YJyxcbiAgICAnU1JWJyxcbiAgICAnU09BJyxcbiAgICAnVExTQScsXG5dO1xuXG5jb25zdCBpcE1hdGNoZXI6IFJlZ0V4cCA9IC9eKD86KD86MlswLTRdXFxkfDI1WzAtNV18MVxcZHsyfXxbMS05XT9cXGQpXFwuKXszfSg/OjJbMC00XVxcZHwyNVswLTVdfDFcXGR7Mn18WzEtOV0/XFxkKSQvO1xuY29uc3QgZGVmYXVsdERuc1NlcnZlcjogSWRuc1NlcnZlciA9IHtcbiAgICBhZGRyZXNzOiAnMS4xLjEuMScsXG4gICAgcG9ydDogNTMsXG4gICAgdHlwZTogJ3RjcCcsXG59O1xuY29uc3QgZGVmYXVsdFRpbWVvdXQgPSAzMDAwO1xuXG4vKipcbiAqIG5vZGUtZG5zIHdyYXBwZXIgbWV0aG9kLlxuICogdHlwZSBpcyByZXNvdXJjZSByZWNvcmQgdHlwZS4gZXhhbXBsZSBcIkFcIiwgXCJNWFwiIGV0Yy5cbiAqIG9wdGlvbiBpcyBub2RlLWRucyByZW1vdGUgZW5kIHBvaW50IG9wdGlvbi5cbiAqIHsgYWRkcmVzczogXCJpcCBhZGRyZXNzXCIsIHBvcnQ6IFwicmVtb3RlIHBvcnQgbnVtYmVyXCIsIHR5cGU6IFwidWRwIG9yIHRjcFwifVxuICogdGltZW91dCBpcyBhIG51bWJlciBpbiBtaWxsaXNlY29uZHMgdGhhdCBpcyB3YWl0IGZvciB0aGUgcmVxdWVzdCB0byBmaW5pc2guXG4gKlxuICogQHBhcmFtIHtTdHJpbmd9IGRvbWFpblxuICogQHBhcmFtIHtBcnJheX0gdHlwZXNcbiAqIEBwYXJhbSB7SWRuc1NlcnZlcn0gb3B0aW9uXG4gKiBAcGFyYW0ge051bWJlcn0gdGltZW91dFxuICogQHJldHVybnMge1Byb21pc2V9XG4gKi9cbmZ1bmN0aW9uIHJlcXVlc3REbnMoZG9tYWluOiBzdHJpbmcsIHR5cGVzPzogc3RyaW5nW10sIG9wdGlvbj86IElkbnNTZXJ2ZXIsIHRpbWVvdXQ/OiBudW1iZXIpOiBQcm9taXNlPGFueT4ge1xuICAgIGNvbnN0IHByb21pc2VzOiBBcnJheTxQcm9taXNlPGFueT4+ID0gW107XG5cbiAgICBsZXQgcmVjb3JkVHlwZXM6IHN0cmluZ1tdID0gW107XG5cbiAgICBpZiAoIXR5cGVzIHx8IHR5cGVzLmxlbmd0aCA9PT0gMCkge1xuICAgICAgICByZWNvcmRUeXBlcyA9IFsnQSddO1xuICAgIH0gZWxzZSB7XG4gICAgICAgIHJlY29yZFR5cGVzID0gdHlwZXM7XG4gICAgfVxuXG4gICAgcmVjb3JkVHlwZXMubWFwKCh0eXBlKSA9PiB7XG4gICAgICAgIHByb21pc2VzLnB1c2goYWpheFJlcXVlc3QoZG9tYWluLCB0eXBlLCBvcHRpb24sIHRpbWVvdXQpKTtcbiAgICB9KTtcblxuICAgIHJldHVybiBuZXcgUHJvbWlzZSgocmVzb2x2ZSwgcmVqZWN0KSA9PiB7XG4gICAgICAgIFByb21pc2VcbiAgICAgICAgICAgIC5hbGwocHJvbWlzZXMpXG4gICAgICAgICAgICAudGhlbigodmFsdWVzKSA9PiB7XG4gICAgICAgICAgICAgICAgY29uc3QgcmVzcG9uc2U6IHtcbiAgICAgICAgICAgICAgICAgICAgW3g6IHN0cmluZ106IElkbnNBbnN3ZXJbXTtcbiAgICAgICAgICAgICAgICB9ID0ge307XG5cbiAgICAgICAgICAgICAgICB2YWx1ZXMubWFwKChvYmopID0+IHtcbiAgICAgICAgICAgICAgICAgICAgT2JqZWN0LmtleXMob2JqKS5tYXAoKGspID0+IHsgcmVzcG9uc2Vba10gPSBvYmpba107IH0pO1xuICAgICAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgICAgIHJlc29sdmUocmVzcG9uc2UpO1xuICAgICAgICAgICAgfSlcbiAgICAgICAgICAgIC5jYXRjaCgoZXJyKSA9PiB7XG4gICAgICAgICAgICAgICAgcmVqZWN0KGVycik7XG4gICAgICAgICAgICB9KTtcbiAgICB9KTtcbn1cblxuLyoqXG4gKiBUaGlzIG1ldGhvZCBhc3luY2hyb25vdXNseSByZXF1ZXN0cyB0aGUgZG5zIHNlcnZlci5cbiAqIFRoaXMgbWV0aG9kIHJldHVybiBwcm9taXNlIG9iamVjdCBhcyBleGVjdXRpb24gcmVzdWx0LlxuICpcbiAqIEBwYXJhbSB7U3RyaW5nfSBkb21haW5cbiAqIEBwYXJhbSB7QXJyYXl9IHR5cGVcbiAqIEBwYXJhbSB7SWRuc1NlcnZlcn0gZG5zU2VydmVyXG4gKiBAcGFyYW0ge051bWJlcn0gdGltZW91dFxuICogQHJldHVybnMge1Byb21pc2V9XG4gKi9cbmZ1bmN0aW9uIGFqYXhSZXF1ZXN0KGRvbWFpbjogc3RyaW5nLCB0eXBlOiBzdHJpbmcsIGRuc1NlcnZlcj86IElkbnNTZXJ2ZXIsIHRpbWVvdXQ6IG51bWJlciA9IGRlZmF1bHRUaW1lb3V0KTogUHJvbWlzZTxhbnk+IHtcbiAgICBjb25zdCBzZXJ2ZXI6IElkbnNTZXJ2ZXIgPSBkZWZhdWx0RG5zU2VydmVyO1xuXG4gICAgcmV0dXJuIG5ldyBQcm9taXNlKChyZXNvbHZlLCByZWplY3QpID0+IHtcbiAgICAgICAgY29uc3QgcXVlc3Rpb25PcHRzID0ge1xuICAgICAgICAgICAgbmFtZTogZG9tYWluLFxuICAgICAgICAgICAgdHlwZSxcbiAgICAgICAgfTtcblxuICAgICAgICBjb25zdCByZXF1ZXN0T3B0aW9uOiBJZG5zUmVxdWVzdFBhcmFtcyA9IHtcbiAgICAgICAgICAgIGNhY2hlOiBmYWxzZSxcbiAgICAgICAgICAgIHF1ZXN0aW9uOiBkbnMuUXVlc3Rpb24ocXVlc3Rpb25PcHRzKSxcbiAgICAgICAgICAgIHNlcnZlcjogT2JqZWN0LmFzc2lnbihzZXJ2ZXIsIGRuc1NlcnZlciksXG4gICAgICAgICAgICB0aW1lb3V0LFxuICAgICAgICB9O1xuXG4gICAgICAgIGlmICh0aW1lb3V0KSB7IHJlcXVlc3RPcHRpb24udGltZW91dCA9IHRpbWVvdXQ7IH1cbiAgICAgICAgY29uc3QgcmVxdWVzdCA9IGRucy5SZXF1ZXN0KHJlcXVlc3RPcHRpb24pO1xuXG4gICAgICAgIHJlcXVlc3Qub24oJ3RpbWVvdXQnLCAoKSA9PiB7XG4gICAgICAgICAgICByZWplY3QobmV3IEVycm9yKCdETlMgcmVxdWVzdCB0aW1lZCBvdXQnKSk7XG4gICAgICAgIH0pO1xuXG4gICAgICAgIHJlcXVlc3Qub24oJ2NhbmNlbGxlZCcsICgpID0+IHtcbiAgICAgICAgICAgIHJlamVjdChuZXcgRXJyb3IoJ0ROUyByZXF1ZXN0IGNhbmNlbGxlZCcpKTtcbiAgICAgICAgfSk7XG5cbiAgICAgICAgcmVxdWVzdC5vbignZXJyb3InLCAoZXJyb3I6IEVycm9yKSA9PiB7XG4gICAgICAgICAgICByZWplY3QoZXJyb3IpO1xuICAgICAgICB9KTtcblxuICAgICAgICByZXF1ZXN0Lm9uKCdtZXNzYWdlJywgKF86IEVycm9yLCByZXNwb25zZTogYW55KSA9PiB7XG4gICAgICAgICAgICByZXNvbHZlKHtcbiAgICAgICAgICAgICAgICBbdHlwZV06IHJlc3BvbnNlLmFuc3dlcixcbiAgICAgICAgICAgIH0pO1xuICAgICAgICB9KTtcblxuICAgICAgICByZXF1ZXN0LnNlbmQoKTtcbiAgICB9KTtcbn1cblxuLyoqXG4gKiBWYWxpZGF0ZSByZXNvdXJjZSByZWNvcmQgdHlwZS5cbiAqXG4gKiBAcGFyYW0ge0FycmF5fFN0cmluZ30gdHlwZXNcbiAqIEByZXR1cm4ge0FycmF5fVxuICovXG5cbmZ1bmN0aW9uIHZhbGlkYXRlRG5zVHlwZSh0eXBlcz86IHN0cmluZyB8IHN0cmluZ1tdKTogc3RyaW5nW10ge1xuICAgIGlmICghdHlwZXMgfHwgKHR5cGVzICE9PSAnQU5ZJyAmJiB0eXBlb2YgdHlwZXMubGVuZ3RoICE9PSAnbnVtYmVyJykpIHtcbiAgICAgICAgdGhyb3cgbmV3IEVycm9yKCdFeHBlY3RlZCBhIGB0eXBlcyBpcyBBcnJheWAnKTtcbiAgICB9XG5cbiAgICBsZXQgcmVjb3JkVHlwZXM6IHN0cmluZ1tdO1xuICAgIGNvbnN0IHZhbGlkVHlwZXM6IHN0cmluZ1tdID0gW107XG5cbiAgICBpZiAodHlwZXMgPT09ICdBTlknIHx8IHR5cGVzLmluY2x1ZGVzKCdBTlknKSkge1xuICAgICAgICByZWNvcmRUeXBlcyA9IGRuc1R5cGVzO1xuICAgIH0gZWxzZSB7XG4gICAgICAgIGlmICh0eXBlb2YgdHlwZXMgPT09ICdzdHJpbmcnKSB7XG4gICAgICAgICAgICByZWNvcmRUeXBlcyA9IFt0eXBlc107XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICByZWNvcmRUeXBlcyA9IHR5cGVzO1xuICAgICAgICB9XG4gICAgfVxuXG4gICAgcmVjb3JkVHlwZXMuZm9yRWFjaCgodHlwZSkgPT4ge1xuICAgICAgICBjb25zdCBtYXRjaGVkID0gZG5zVHlwZXMuZmluZCggZWxlbSA9PiB7XG4gICAgICAgICAgICByZXR1cm4gdHlwZS50b1VwcGVyQ2FzZSgpID09PSBlbGVtO1xuICAgICAgICB9KTtcblxuICAgICAgICBpZiAodHlwZW9mIG1hdGNoZWQgPT09ICdzdHJpbmcnKSB7XG4gICAgICAgICAgICB2YWxpZFR5cGVzLnB1c2gobWF0Y2hlZCk7XG4gICAgICAgIH1cbiAgICB9KTtcblxuICAgIHJldHVybiB2YWxpZFR5cGVzO1xufVxuXG4vKipcbiAqIEdldCBXaG9pcyBzZXJ2ZXIgYW5kIFdob2lzIGRvbWFpbi5cbiAqIEZpcnN0LCBNYWtlIHRoZSBGUUROIHRoYXQgd2FzIHRoZSBUTEQgKyB3aG9pcy1zZXJ2ZXJzLm5ldC5cbiAqXG4gKiBAcGFyYW0ge1N0cmluZ30gZG9tYWluXG4gKiBAcGFyYW0ge09iamVjdH0gb3B0aW9uc1xuICogQHJldHVybiB7UHJvbWlzZX1cbiAqL1xuZnVuY3Rpb24gcmVxdWVzdFdob2lzKGRvbWFpbjogc3RyaW5nLCBvcHRpb25zPzogYW55KTogUHJvbWlzZTxhbnk+IHtcbiAgICBsZXQgd2hvaXNTZXJ2ZXI6IHN0cmluZyxcbiAgICAgICAgcG9ydDogbnVtYmVyO1xuXG4gICAgcmV0dXJuIG5ldyBQcm9taXNlKChyZXNvbHZlLCByZWplY3QpID0+IHtcbiAgICAgICAgY29uc3QgZnVuYyA9IChkb21haW46IHN0cmluZywgd2hvaXNTZXJ2ZXI6IHN0cmluZywgcG9ydDogbnVtYmVyKSA9PiB7XG4gICAgICAgICAgICBnZXRXaG9pc0RvbWFpbihkb21haW4sIHdob2lzU2VydmVyLCBwb3J0KVxuICAgICAgICAgICAgICAgIC50aGVuKChkYXRhKSA9PiB7IHJlc29sdmUoZGF0YSk7IH0pXG4gICAgICAgICAgICAgICAgLmNhdGNoKChlcnJvcikgPT4geyByZWplY3QoZXJyb3IpOyB9KTtcbiAgICAgICAgfTtcblxuICAgICAgICBpZiAob3B0aW9ucyAmJiBvcHRpb25zLnNlcnZlcikge1xuICAgICAgICAgICAgd2hvaXNTZXJ2ZXIgPSBvcHRpb25zLnNlcnZlcjtcbiAgICAgICAgICAgIGlmIChvcHRpb25zLnBvcnQpIHsgcG9ydCA9IG9wdGlvbnMucG9ydDsgfVxuICAgICAgICAgICAgZnVuYy5jYWxsKG51bGwsIGRvbWFpbiwgd2hvaXNTZXJ2ZXIsIHBvcnQpO1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgZ2V0VG9wTGV2ZWxXaG9pc1NlcnZlcihkb21haW4pLnRoZW4oKHdob2lzU2VydmVycykgPT4ge1xuICAgICAgICAgICAgICAgIHdob2lzU2VydmVyID0gd2hvaXNTZXJ2ZXJzWzBdO1xuICAgICAgICAgICAgICAgIGZ1bmMuY2FsbChudWxsLCBkb21haW4sIHdob2lzU2VydmVyLCBwb3J0KTtcbiAgICAgICAgICAgIH0pLmNhdGNoKChlcnJvcikgPT4ge1xuICAgICAgICAgICAgICAgIHJlamVjdChlcnJvcik7XG4gICAgICAgICAgICB9KTtcbiAgICAgICAgfVxuICAgIH0pO1xufVxuXG4vKipcbiAqIEdldCB0aGUgd2hvaXMgc2VydmVyIG9mIHRoZSB0b3AgbGV2ZWwgZG9tYWluXG4gKlxuICogQHBhcmFtIHtTdHJpbmd9IGRvbWFpblxuICogQHJldHVybiB7UHJvbWlzZX1cbiAqL1xuZnVuY3Rpb24gZ2V0VG9wTGV2ZWxXaG9pc1NlcnZlcihkb21haW46IHN0cmluZyk6IFByb21pc2U8YW55PiB7XG4gICAgY29uc3QgdG1wID0gZG9tYWluLnNwbGl0KCcuJyksXG4gICAgICAgIHRsZCA9IHRtcFt0bXAubGVuZ3RoIC0gMV0sXG4gICAgICAgIGNuYW1lID0gYCR7dGxkfS4ke3RvcExldmVsV2hvaXNTZXJ2ZXJEb21haX1gLFxuICAgICAgICBtZXNzZWdlID0geyBub3RfZm91bmQ6ICdXaG9pcyBTZXJ2ZXIgYE5PVCBGT1VORGAnIH07XG5cbiAgICByZXR1cm4gbmV3IFByb21pc2UoKHJlc29sdmUsIHJlamVjdCkgPT4ge1xuICAgICAgICBkbnMucmVzb2x2ZUNuYW1lKGNuYW1lLCAoZXJyb3I6IEVycm9yLCBzZXJ2ZXJzOiBhbnkpID0+IHtcbiAgICAgICAgICAgIGlmIChzZXJ2ZXJzICYmIHNlcnZlcnMubGVuZ3RoID4gMCkge1xuICAgICAgICAgICAgICAgIHJlc29sdmUoc2VydmVycyk7XG4gICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgICFlcnJvciA/IHJlamVjdChtZXNzZWdlLm5vdF9mb3VuZCkgOiByZWplY3QoZXJyb3IpO1xuICAgICAgICAgICAgfVxuICAgICAgICB9KTtcbiAgICB9KTtcbn1cblxuLyoqXG4gKiBHZXQgd2hvaXMgaW5mb3JtYXRpb24gb2YgdGhlIGRvbWFpblxuICpcbiAqIEBwYXJhbSB7U3RyaW5nfSBkb21haW5cbiAqIEBwYXJhbSB7U3RyaW5nfSBzZXJ2ZXJcbiAqIEByZXR1cm4ge1Byb21pc2V9XG4gKi9cbmZ1bmN0aW9uIGdldFdob2lzRG9tYWluKGRvbWFpbjogc3RyaW5nLCBzZXJ2ZXI6IHN0cmluZywgcG9ydCA9IDQzKTogUHJvbWlzZTxhbnk+IHtcbiAgICBpZiAoIWRvbWFpbikgeyB0aHJvdyBuZXcgRXJyb3IoJ2Bkb21haW5gIGlzIHJlcXVpcmVkJyk7IH1cbiAgICBpZiAoIXNlcnZlcikgeyB0aHJvdyBuZXcgRXJyb3IoJ2BzZXJ2ZXJgIGlzIHJlcXVpcmVkJyk7IH1cblxuICAgIGNvbnN0IHNvY2tldCA9IG5ldyBuZXQuU29ja2V0KCk7XG4gICAgY29uc3QgZW5jb2RpbmcgPSAndXRmOCc7XG5cbiAgICByZXR1cm4gbmV3IFByb21pc2UoKHJlc29sdmUsIHJlamVjdCkgPT4ge1xuICAgICAgICBzb2NrZXQuc2V0RW5jb2RpbmcoZW5jb2RpbmcpO1xuXG4gICAgICAgIHNvY2tldC5jb25uZWN0KHBvcnQsIHNlcnZlciwgKCkgPT4ge1xuICAgICAgICAgICAgc29ja2V0LmVuZChkb21haW4gKyAnXFxyXFxuJywgZW5jb2RpbmcpO1xuICAgICAgICB9KTtcblxuICAgICAgICBzb2NrZXQub24oJ2RhdGEnLCAoZGF0YSkgPT4ge1xuICAgICAgICAgICAgcmVzb2x2ZShkYXRhKTtcbiAgICAgICAgfSk7XG5cbiAgICAgICAgc29ja2V0Lm9uKCdlcnJvcicsIChlcnJvcikgPT4ge1xuICAgICAgICAgICAgcmVqZWN0KGVycm9yKTtcbiAgICAgICAgfSk7XG4gICAgfSk7XG59XG5cbi8qKlxuICogSVAgYWRkcmVzcyByZXZlcnNlLlxuICogc3VwcG9ydCBpcHY0IG9ubHkuXG4gKlxuICogQHBhcmFtIHtTdHJpbmd9IGlwXG4gKiBAcmV0dXJuIHtQcm9taXNlfVxuICovXG5mdW5jdGlvbiByZXZlcnNlRG9tYWluKGlwOiBzdHJpbmcpOiBQcm9taXNlPHN0cmluZz4ge1xuICAgIGlmICghaXBNYXRjaGVyLnRlc3QoaXApKSB7XG4gICAgICAgIHRocm93IG5ldyBFcnJvcignSVAgaXMgbm90IHZhbGlkJyk7XG4gICAgfVxuXG4gICAgcmV0dXJuIG5ldyBQcm9taXNlKChyZXNvbHZlLCByZWplY3QpID0+IHtcbiAgICAgICAgZG5zLnJldmVyc2UoaXAsIChlcnJvcjogRXJyb3IsIGhvc3RuYW1lOiBzdHJpbmcpID0+IHtcbiAgICAgICAgICAgIGlmIChyZXZlcnNlKSB7XG4gICAgICAgICAgICAgICAgcmVzb2x2ZShob3N0bmFtZSk7XG4gICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgIHJlamVjdChlcnJvcik7XG4gICAgICAgICAgICB9XG4gICAgICAgIH0pO1xuICAgIH0pO1xufVxuXG4vKipcbiAqIERlY29kZSBQdW55Y29kZS5cbiAqXG4gKiBAcGFyYW0ge1N0cmluZ30gYXNjaWlcbiAqIEByZXR1cm4ge1N0cmluZ31cbiAqL1xuZnVuY3Rpb24gZGVjb2RlUHVueShhc2NpaTogc3RyaW5nKTogc3RyaW5nIHtcbiAgICByZXR1cm4gcHVueS50b1VuaWNvZGUoYXNjaWkpO1xufVxuXG4vKipcbiAqIEVuY29kZSBQdW55Y29kZS5cbiAqXG4gKiBAcGFyYW0ge1N0cmluZ30gdW5pY29kZVxuICogQHJldHVybiB7U3RyaW5nfVxuICovXG5mdW5jdGlvbiBlbmNvZGVQdW55KHVuaWNvZGU6IHN0cmluZyk6IHN0cmluZyB7XG4gICAgcmV0dXJuIHB1bnkudG9BU0NJSSh1bmljb2RlKTtcbn1cblxuZXhwb3J0IGNvbnN0IGdyb3BlciA9IChkb21haW46IHN0cmluZywgdHlwZXM/OiBhbnksIG9wdGlvbnM/OiBJZG5zUmVxdWVzdFBhcmFtcywgY2I/OiBjYWxsYmFja0Z1bmN0aW9uKTogUHJvbWlzZTxhbnk+IHwgdm9pZCA9PiB7XG4gICAgaWYgKHR5cGVvZiBkb21haW4gIT09ICdzdHJpbmcnKSB7IHRocm93IG5ldyBFcnJvcignRXhwZWN0ZWQgYSBgZG9tYWluYCcpOyB9XG5cbiAgICBjb25zdCBkZWZhdWx0T3B0aW9uczogSWRuc1JlcXVlc3RQYXJhbXMgPSB7XG4gICAgICAgIHNlcnZlcjogZGVmYXVsdERuc1NlcnZlcixcbiAgICAgICAgdGltZW91dDogZGVmYXVsdFRpbWVvdXQsXG4gICAgfTtcblxuICAgIGxldCBjYWxsYmFjazogY2FsbGJhY2tGdW5jdGlvbjtcbiAgICBsZXQgcmVxdWVzdE9wdGlvbnM6IElkbnNSZXF1ZXN0UGFyYW1zID0gZGVmYXVsdE9wdGlvbnM7XG5cbiAgICBpZiAodHlwZW9mIHR5cGVzID09PSAnZnVuY3Rpb24nKSB7XG4gICAgICAgIGNhbGxiYWNrID0gdHlwZXM7XG4gICAgfSBlbHNlIGlmICh0eXBlb2Ygb3B0aW9ucyA9PT0gJ2Z1bmN0aW9uJykge1xuICAgICAgICBjYWxsYmFjayA9IG9wdGlvbnM7XG4gICAgICAgIHJlcXVlc3RPcHRpb25zID0gT2JqZWN0LmFzc2lnbihkZWZhdWx0T3B0aW9ucywgY2IpO1xuICAgIH0gZWxzZSBpZiAoY2IpIHtcbiAgICAgICAgcmVxdWVzdE9wdGlvbnMgPSBPYmplY3QuYXNzaWduKGRlZmF1bHRPcHRpb25zLCBvcHRpb25zKTtcbiAgICAgICAgY2FsbGJhY2sgPSBjYjtcbiAgICB9XG5cbiAgICBjb25zdCBkb21haW5OYW1lID0gZW5jb2RlUHVueShkb21haW4pO1xuICAgIGxldCB0eXBlLCBzZXJ2ZXIsIHRpbWVvdXQsIHJlc291cmNlVHlwZXMgPSBbJ0FOWSddO1xuXG4gICAgaWYgKHR5cGVvZiB0eXBlcyA9PT0gJ3N0cmluZycpIHsgcmVzb3VyY2VUeXBlcyA9IG5ldyBBcnJheSh0eXBlcyk7IH1cbiAgICBpZiAoQXJyYXkuaXNBcnJheSh0eXBlcykpIHsgcmVzb3VyY2VUeXBlcyA9IHR5cGVzOyB9XG4gICAgaWYgKHJlc291cmNlVHlwZXMuaW5jbHVkZXMoJ0FOWScpKSB7IHJlc291cmNlVHlwZXMgPSBbJ0FOWSddOyB9XG5cbiAgICB0eXBlID0gdmFsaWRhdGVEbnNUeXBlKHJlc291cmNlVHlwZXMpO1xuXG4gICAgaWYgKHR5cGUubGVuZ3RoID09PSAwKSB7XG4gICAgICAgIHRocm93IG5ldyBFcnJvcignVmFsaWQgTm8gYEROUyBUWVBFYCBleGl0c3QnKTtcbiAgICB9XG5cbiAgICBpZiAocmVxdWVzdE9wdGlvbnMuc2VydmVyKSB7IHNlcnZlciA9IHJlcXVlc3RPcHRpb25zLnNlcnZlcjsgfVxuICAgIGlmIChyZXF1ZXN0T3B0aW9ucy50aW1lb3V0KSB7IHRpbWVvdXQgPSByZXF1ZXN0T3B0aW9ucy50aW1lb3V0OyB9XG4gICAgY29uc3QgcHJvbWlzZSA9IHJlcXVlc3REbnMoZG9tYWluTmFtZSwgdHlwZSwgc2VydmVyLCB0aW1lb3V0KTtcblxuICAgIGlmIChjYWxsYmFjayAmJiB0eXBlb2YgY2FsbGJhY2sgPT09ICdmdW5jdGlvbicpIHtcbiAgICAgICAgcHJvbWlzZVxuICAgICAgICAgICAgLnRoZW4oKGRhdGEpID0+IGNhbGxiYWNrKG51bGwsIGRhdGEpKVxuICAgICAgICAgICAgLmNhdGNoKChlcnJvcikgPT4gY2FsbGJhY2soZXJyb3IsIG51bGwpKTtcbiAgICB9IGVsc2Uge1xuICAgICAgICByZXR1cm4gcHJvbWlzZTtcbiAgICB9XG59O1xuXG5leHBvcnQgY29uc3QgcmV2ZXJzZSA9IChpcDogc3RyaW5nLCBjYjogY2FsbGJhY2tGdW5jdGlvbik6IFByb21pc2U8c3RyaW5nPiB8IHZvaWQgPT4ge1xuICAgIGlmICh0eXBlb2YgaXAgIT09ICdzdHJpbmcnKSB7XG4gICAgICAgIHRocm93IG5ldyBFcnJvcignRXhwZWN0ZWQgYSBgaXAgYWRkcmVzc2AnKTtcbiAgICB9XG5cbiAgICBjb25zdCBwcm9taXNlID0gcmV2ZXJzZURvbWFpbihpcCk7XG5cbiAgICBpZiAoY2IgJiYgdHlwZW9mIGNiID09PSAnZnVuY3Rpb24nKSB7XG4gICAgICAgIHByb21pc2VcbiAgICAgICAgICAgIC50aGVuKChkYXRhKSA9PiBjYihudWxsLCBkYXRhKSlcbiAgICAgICAgICAgIC5jYXRjaCgoZXJyb3IpID0+IGNiKGVycm9yLCBudWxsKSk7XG4gICAgfSBlbHNlIHtcbiAgICAgICAgcmV0dXJuIHByb21pc2U7XG4gICAgfVxufTtcblxuZXhwb3J0IGNvbnN0IHdob2lzID0gKGRvbWFpbjogc3RyaW5nLCBvcHRzPzogSXdob2lzU2VydmVyLCBjYj86IGNhbGxiYWNrRnVuY3Rpb24pOiBQcm9taXNlPGFueT4gfCB2b2lkID0+IHtcbiAgICBpZiAodHlwZW9mIGRvbWFpbiAhPT0gJ3N0cmluZycpIHtcbiAgICAgICAgdGhyb3cgbmV3IEVycm9yKCdFeHBlY3RlZCBhIGBkb21haW4gbmFtZWAnKTtcbiAgICB9XG5cbiAgICBsZXQgY2FsbGJhY2s6IGNhbGxiYWNrRnVuY3Rpb247XG5cbiAgICBpZiAodHlwZW9mIG9wdHMgPT09ICdmdW5jdGlvbicpIHtcbiAgICAgICAgY2FsbGJhY2sgPSBvcHRzO1xuICAgIH0gZWxzZSB7XG4gICAgICAgIGNhbGxiYWNrID0gY2I7XG4gICAgfVxuXG4gICAgaWYgKHRsZGpzLnRsZEV4aXN0cyhkb21haW4pID09PSBmYWxzZSkge1xuICAgICAgICB0aHJvdyBuZXcgRXJyb3IoJ0ludmFsaWQgYSBgZG9tYWluIG5hbWVgJyk7XG4gICAgfVxuXG4gICAgY29uc3QgZW5jb2RlZERvbWFpbiA9IGAke2VuY29kZVB1bnkoZG9tYWluKX1gLFxuICAgICAgICBwcm9taXNlID0gcmVxdWVzdFdob2lzKGVuY29kZWREb21haW4sIG9wdHMpO1xuXG4gICAgaWYgKGNhbGxiYWNrICYmIHR5cGVvZiBjYWxsYmFjayA9PT0gJ2Z1bmN0aW9uJykge1xuICAgICAgICBwcm9taXNlXG4gICAgICAgICAgICAudGhlbigoZGF0YSkgPT4gY2FsbGJhY2sobnVsbCwgZGF0YSkpXG4gICAgICAgICAgICAuY2F0Y2goKGVycm9yKSA9PiBjYWxsYmFjayhlcnJvciwgbnVsbCkpO1xuICAgIH0gZWxzZSB7XG4gICAgICAgIHJldHVybiBwcm9taXNlO1xuICAgIH1cbn07XG5cbmV4cG9ydCBjb25zdCBwdW55Y29kZSA9IChhc2NpaV9vcl91bmljb2RlOiBzdHJpbmcpOiBzdHJpbmcgPT4ge1xuICAgIGNvbnN0IHR5cGUgPSBhc2NpaV9vcl91bmljb2RlLm1hdGNoKC9eeG4tLS8pID8gJ2RlY29kZScgOiAnZW5jb2RlJztcbiAgICBpZiAodHlwZSA9PT0gJ2RlY29kZScpIHtcbiAgICAgICAgcmV0dXJuIGRlY29kZVB1bnkoYXNjaWlfb3JfdW5pY29kZSk7XG4gICAgfSBlbHNlIHtcbiAgICAgICAgcmV0dXJuIGVuY29kZVB1bnkoYXNjaWlfb3JfdW5pY29kZSk7XG4gICAgfVxufTtcbiJdfQ==